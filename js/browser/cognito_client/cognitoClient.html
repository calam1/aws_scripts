<!DOCTYPE html>
<html>

<head>
    <title>Cognito Example</title>
    <script src="lib/aws-cognito-sdk.min.js"></script>
    <script src="lib/jsbn.js"></script>
    <script src="lib/jsbn2.js"></script>
    <script src="lib/moment.js"></script>
    <script src="lib/sjcl.js"></script>
    <script src="lib/aws-sdk.min.js"></script>
    <script src="lib/amazon-cognito-identity.min.js"></script>

    <script>
        function createIdentityId() {
            AWS.config.region = 'us-east-1';
            var cognitoidentity = new AWS.CognitoIdentity({
                apiVersion: '2014-06-30'
            });

            // getId - http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/CognitoIdentity.html#getId-property
            var params = {
                IdentityPoolId: 'us-east-1:633d5440-9196-45f7-839c-0c118877b380',
            };

            // Generates (or retrieves) a Cognito ID. Supplying multiple logins (attribute in params, you can pass in
            // will create an implicit linked account.
            // This is a public API. You do not need any credentials to call this API.
            cognitoidentity.getId(params, function(err, data) {
                if (err) {
                    console.log('error', err);
                } else {
                    console.log('cognito id:', data);
                    alert('cognito id/ idendityId:' + data.IdentityId);
                }
            });
        }

        function register(obj) {
            //alert(obj['username'].value);
            //alert(obj['password'].value);
            //alert(obj['email'].value);
            //alert(obj['identityId'].value);

            var username = obj['username'].value;
            var password = obj['password'].value;
            var email = obj['email'].value;
            var identityId = obj['identityId'].value;

            // to attach this user to an identity id we need set the credential 
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'us-east-1:633d5440-9196-45f7-839c-0c118877b380',
                IdentityId: identityId
            });

            AWS.config.region = 'us-east-1';


            AWSCognito.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'us-east-1:633d5440-9196-45f7-839c-0c118877b380',
                IdentityId: identityId
            });

            AWSCognito.config.region = 'us-east-1';

            AWSCognito.config.update({
                accessKeyId: 'anything',
                secretAccessKey: 'anything'
            })

            var poolData = {
                UserPoolId: 'us-east-1_DLWkDQlGD',
                ClientId: '7civ431fec41bb280096co5vp8'
            };
            var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData);

            var attributeList = [];

            var dataEmail = {
                Name: 'email',
                Value: email
            };

            var attributeEmail = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserAttribute(dataEmail);

            attributeList.push(attributeEmail);

            userPool.signUp(username, password, attributeList, null, function(err, result) {
                if (err) {
                    alert(err);
                    return;
                }
                cognitoUser = result.user;
                console.log('cognito user object:', cognitoUser);
                console.log('user name is ' + cognitoUser.getUsername());
            });
        };

        function confirm(object) {
            var username = obj['username'].value;
            var confirmationCode = obj['confirmationCode'].value;

            var poolData = {
                UserPoolId: 'us-east-1_DLWkDQlGD',
                ClientId: '7civ431fec41bb280096co5vp8'
            };

            var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData);
            var userData = {
                Username: 'username',
                Pool: userPool
            };

            var cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(userData);
            cognitoUser.confirmRegistration(confirmationCode, true, function(err, result) {
                if (err) {
                    alert(err);
                    return;
                }
                console.log('call result: ' + result);
            });
        };

        function login(object) {
            var username = obj['username'].value;
            var password = obj['password'].value;
            var identityId = obj['identityId'].value;

            var creds = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'us-east-1:633d5440-9196-45f7-839c-0c118877b380',
                IdentityId: identityId

            });

            AWS.config.credentials = creds;

            AWS.config.region = 'us-east-1';

            console.log('creds values before authentication', creds);

            AWSCognito.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'us-east-1:633d5440-9196-45f7-839c-0c118877b380',
                IdentityId: identityId
            });

            AWSCognito.config.region = 'us-east-1';

            var authenticationData = {
                Username: username,
                Password: password
            };
            var authenticationDetails = new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails(authenticationData);
            var poolData = {
                UserPoolId: 'us-east-1_DLWkDQlGD',
                ClientId: '7civ431fec41bb280096co5vp8'
            };
            var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData);
            var userData = {
                Username: username,
                Pool: userPool
            };
            var cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(userData);
            console.log('right before authenticate user');
            // this will return the access key , secret key, etc, and link the user to the identity id, if we set the identity id in the creds
            cognitoUser.authenticateUser(authenticationDetails, {
                onSuccess: function(result) {
                    console.log('access token + ' + result.getAccessToken().getJwtToken());

                    console.log('authenticate user result', result);
                    creds.params.Logins = {
                        'cognito-idp.us-east-1.amazonaws.com/us-east-1_DLWkDQlGD': result.getIdToken().getJwtToken()
                    };
                    creds.expired = true;

                    console.log('creds.params values after authentication', creds.params);
                    console.log('creds values after authentication', creds);

                    AWS.config.credentials.get(function(err) {
                        if (!err) {
                            console.log('Cognito Identity Id:' + AWS.config.credentials.identityId);
                        }
                    });

                    // Instantiate aws sdk service objects now that the credentials have been updated.
                    // example: var s3 = new AWS.S3();



                    //var s3 = new AWS.S3({
                    //    region: 'us-east-1'
                    //});
                    //s3.listObjects({
                    //    Bucket: 'bucket'
                    //}, function(err, data) {
                    //    if (err) console.log(err);
                    //    else console.log(data);
                    //});


                },

                onFailure: function(err) {
                    alert(err);
                },

            });

        };

        function getAttrs(object) {
            var creds = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'us-east-1:633d5440-9196-45f7-839c-0c118877b380',
                IdentityId: 'us-east-1:0e164f53-b87b-4082-a784-38c4f8e39a2e'
            });

            AWS.config.credentials = creds;

            AWS.config.region = 'us-east-1';
            AWS.config.credentials.get(function(err) {
                if (!err) {
                    console.log('Cognito Identity Id:' + AWS.config.credentials.identityId);
                }
            });

            var authenticationData = {
                Username: 'clam',
                Password: 'password',
            };
            var authenticationDetails = new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails(authenticationData);
            var poolData = {
                UserPoolId: 'us-east-1_DLWkDQlGD',
                ClientId: '7civ431fec41bb280096co5vp8'
            };
            var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData);
            var userData = {
                Username: 'clam',
                Pool: userPool
            };
            var cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(userData);

            cognitoUser.getUserAttributes(function(err, result) {
                if (err) {
                    alert(err);
                    return;
                }
                for (i = 0; i < result.length; i++) {
                    console.log('attribute ' + result[i].getName() + ' has value ' + result[i].getValue());
                }
            });
        }
    </script>
</head>

<body>
    <h1>cognito example</h1>

    <form action="javascript:;" enctype="application/json" method="post" onsubmit="createIdentityId()">
        <input type="submit" value="Create IdentityId">
    </form>
    <br>
    <form action="javascript:;" enctype="application/json" method="post" onsubmit="register(this)">
        <table>
            <tr>
                <td align="right">username:</td>
                <td align="left"> <input type="text" name="username" value=""></td>
            </tr>
            <tr>
                <td align="right">password:</td>
                <td align="left"><input type="text" name="password" value=""></td>
            </tr>
            <tr>
                <td align="right">email:</td>
                <td align="left"><input type="text" name="email" value=""></td>
            </tr>
            <tr>
                <td align="right">identityId:</td>
                <td align="left"><input type="text" name="identityId" value=""></td>
            </tr>
            <tr>
                <td align="left"><input type="submit" value="Register"></td>
            </tr>
        </table>
    </form>
    <br>
    <form action="javascript:;" enctype="application/json" method="post" onsubmit="confirm(this)">
        <table>
            <tr>
                <td align="right">username:</td>
                <td align="left"> <input type="text" name="username" value=""></td>
            </tr>
            <tr>
                <td align="right">confirmation code:</td>
                <td align="left"><input type="text" name="confirmationCode" value=""></td>
            </tr>
            <tr>
                <td align="left"><input type="submit" value="Confirm"></td>
            </tr>
        </table>
    </form>
    <br>
    <form action="javascript:;" enctype="application/json" method="post" onsubmit="login(this)">
        <table>
            <tr>
                <td align="right">username:</td>
                <td align="left"> <input type="text" name="username" value=""></td>
            </tr>
            <tr>
                <td align="right">password:</td>
                <td align="left"><input type="text" name="password" value=""></td>
            </tr>
            <tr>
                <td align="right">identityId:</td>
                <td align="left"><input type="text" name="identityId" value=""></td>
            </tr>
            <tr>
                <td align="left"><input type="submit" value="Login"></td>
            </tr>
        </table>
    </form>
    <br>
    <form action="javascript:;" enctype="application/json" method="post" onsubmit="getAttrs(this)">
        <input type="submit" value="Get Attributes">
    </form>



</body>

</html>